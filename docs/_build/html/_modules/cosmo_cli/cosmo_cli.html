

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cosmo_cli.cosmo_cli &mdash; cloudify-cli 3.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="cloudify-cli 3.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> cloudify-cli</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="simple">
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">cloudify-cli</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>cosmo_cli.cosmo_cli</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for cosmo_cli.cosmo_cli</h1><div class="highlight"><pre>
<span class="c">########</span>
<span class="c"># Copyright (c) 2013 GigaSpaces Technologies Ltd. All rights reserved</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#        http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>
<span class="c">############</span>

<span class="kn">import</span> <span class="nn">messages</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;ran&#39;</span>

<span class="c"># Standard</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">argcomplete</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="kn">import</span> <span class="nn">formatting</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span><span class="p">,</span> <span class="n">local</span>
<span class="kn">from</span> <span class="nn">fabric.context_managers</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">system</span>
<span class="kn">from</span> <span class="nn">distutils.spawn</span> <span class="kn">import</span> <span class="n">find_executable</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>

<span class="c"># Project</span>
<span class="kn">from</span> <span class="nn">dsl_parser.parser</span> <span class="kn">import</span> <span class="n">parse_from_path</span><span class="p">,</span> <span class="n">DSLParsingException</span>
<span class="kn">from</span> <span class="nn">cloudify_rest_client</span> <span class="kn">import</span> <span class="n">CloudifyClient</span>
<span class="kn">from</span> <span class="nn">cloudify_rest_client.exceptions</span> <span class="kn">import</span> <span class="n">CloudifyClientError</span>
<span class="kn">from</span> <span class="nn">cloudify_rest_client.exceptions</span> <span class="kn">import</span> <span class="n">CreateDeploymentInProgressError</span>
<span class="kn">from</span> <span class="nn">executions</span> <span class="kn">import</span> <span class="n">wait_for_execution</span>
<span class="kn">from</span> <span class="nn">executions</span> <span class="kn">import</span> <span class="n">get_deployment_creation_execution</span>
<span class="kn">from</span> <span class="nn">executions</span> <span class="kn">import</span> <span class="n">get_all_execution_events</span>
<span class="kn">from</span> <span class="nn">executions</span> <span class="kn">import</span> <span class="n">ExecutionTimeoutError</span>


<span class="n">output_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
<span class="n">CLOUDIFY_WD_SETTINGS_FILE_NAME</span> <span class="o">=</span> <span class="s">&#39;.cloudify&#39;</span>

<span class="n">CONFIG_FILE_NAME</span> <span class="o">=</span> <span class="s">&#39;cloudify-config.yaml&#39;</span>
<span class="n">DEFAULTS_CONFIG_FILE_NAME</span> <span class="o">=</span> <span class="s">&#39;cloudify-config.defaults.yaml&#39;</span>

<span class="n">AGENT_MIN_WORKERS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">AGENT_MAX_WORKERS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">AGENT_KEY_PATH</span> <span class="o">=</span> <span class="s">&#39;~/.ssh/cloudify-agents-kp.pem&#39;</span>
<span class="n">REMOTE_EXECUTION_PORT</span> <span class="o">=</span> <span class="mi">22</span>

<span class="n">WORKFLOW_TASK_RETRIES</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">WORKFLOW_TASK_RETRY_INTERVAL</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c"># http://stackoverflow.com/questions/8144545/turning-off-logging-in-paramiko</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;paramiko&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&quot;requests.packages.urllib3.connectionpool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>


<div class="viewcode-block" id="init_logger"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.init_logger">[docs]</a><span class="k">def</span> <span class="nf">init_logger</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    initializes a logger to be used throughout the cli</span>
<span class="sd">    can be used by provider codes.</span>

<span class="sd">    :rtype: `tupel` with 2 loggers, one for users (writes to console and file),</span>
<span class="sd">     and the other for archiving (writes to file only).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">LOG_DIR</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;file {0} exists - cloudify log directory cannot be created &#39;</span>
                 <span class="s">&#39;there. please remove the file and try again.&#39;</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">LOG_DIR</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">LOGGER</span><span class="p">[</span><span class="s">&#39;handlers&#39;</span><span class="p">][</span><span class="s">&#39;file&#39;</span><span class="p">][</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">LOGGER</span><span class="p">)</span>
        <span class="n">lgr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">flgr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;file&#39;</span><span class="p">)</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">lgr</span><span class="p">,</span> <span class="n">flgr</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;could not initialize logger.&#39;</span>
                 <span class="s">&#39; verify your logger config&#39;</span>
                 <span class="s">&#39; and permissions to write to {0}&#39;</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>

<span class="c"># initialize logger</span></div>
<span class="n">lgr</span><span class="p">,</span> <span class="n">flgr</span> <span class="o">=</span> <span class="n">init_logger</span><span class="p">()</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">_parse_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">args</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the arguments using the Python argparse library.</span>
<span class="sd">    Generates shell autocomplete using the argcomplete library.</span>

<span class="sd">    :param list args: arguments from cli</span>
<span class="sd">    :rtype: `python argument parser`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># main parser</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s">&#39;Manages Cloudify in different Cloud Environments&#39;</span><span class="p">)</span>

    <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">()</span>
    <span class="n">parser_status</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;status&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Show a management server</span><span class="se">\&#39;</span><span class="s">s status&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_use</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;use&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Use/switch to the specified management server&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_init</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;init&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Initialize configuration files for a specific cloud provider&#39;</span>

    <span class="p">)</span>
    <span class="n">parser_bootstrap</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;bootstrap&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Bootstrap Cloudify on the currently active provider&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_teardown</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;teardown&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Teardown Cloudify&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_blueprints</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;blueprints&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Manages Cloudify</span><span class="se">\&#39;</span><span class="s">s Blueprints&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_deployments</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;deployments&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Manages and Executes Cloudify</span><span class="se">\&#39;</span><span class="s">s Deployments&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_executions</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;executions&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Manages Cloudify Executions&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_workflows</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;workflows&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Manages Deployment Workflows&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_events</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;events&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Displays Events for different executions&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_dev</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;dev&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_ssh</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;ssh&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;SSH to management server&#39;</span>
    <span class="p">)</span>

    <span class="c"># status subparser</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_status</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_status</span><span class="p">,</span> <span class="n">_status</span><span class="p">)</span>

    <span class="c"># use subparser</span>
    <span class="n">parser_use</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;management_ip&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;MANAGEMENT_IP&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The cloudify management server ip address&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_use</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-a&#39;</span><span class="p">,</span> <span class="s">&#39;--alias&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;alias&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;ALIAS&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;An alias for the management server&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_force_optional_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_use</span><span class="p">,</span>
        <span class="s">&#39;A flag indicating authorization to overwrite the alias if it &#39;</span>
        <span class="s">&#39;already exists&#39;</span>
    <span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_use</span><span class="p">,</span> <span class="n">_use_management_server</span><span class="p">)</span>

    <span class="c"># init subparser</span>
    <span class="n">parser_init</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;provider&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PROVIDER&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Command for initializing configuration files for a&#39;</span>
             <span class="s">&#39; specific provider&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_init</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--target-dir&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;target_dir&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;TARGET_DIRECTORY&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The target directory to be initialized for the given provider&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_init</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-r&#39;</span><span class="p">,</span> <span class="s">&#39;--reset-config&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;reset_config&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag indicating overwriting existing configuration is allowed&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_init</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--install&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;install&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PROVIDER_MODULE_URL&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;url to provider module&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_init</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--creds&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;creds&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;PROVIDER_CREDENTIALS&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;a comma separated list of key=value credentials&#39;</span>
    <span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_init</span><span class="p">,</span> <span class="n">_init_cosmo</span><span class="p">)</span>

    <span class="c"># bootstrap subparser</span>
    <span class="n">parser_bootstrap</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--config-file&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;config_file_path&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;CONFIG_FILE&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Path to a provider configuration file&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_bootstrap</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--keep-up-on-failure&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;keep_up&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag indicating that even if bootstrap fails,&#39;</span>
        <span class="s">&#39; the instance will remain running&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_bootstrap</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--dev-mode&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;dev_mode&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag indicating that bootstrap will be run in dev-mode,&#39;</span>
        <span class="s">&#39; allowing to choose specific branches to run with&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_bootstrap</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--skip-validations&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;skip_validations&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag indicating that bootstrap will be run without,&#39;</span>
        <span class="s">&#39; validating resources prior to bootstrapping the manager&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_bootstrap</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--validate-only&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;validate_only&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag indicating that validations will run without,&#39;</span>
        <span class="s">&#39; actually performing the bootstrap process.&#39;</span>
    <span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_bootstrap</span><span class="p">,</span> <span class="n">_bootstrap_cosmo</span><span class="p">)</span>

    <span class="c"># teardown subparser</span>
    <span class="n">parser_teardown</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--config-file&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;config_file_path&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;CONFIG_FILE&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Path to a provider configuration file&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_teardown</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--ignore-deployments&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;ignore_deployments&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag indicating confirmation for teardown even if there &#39;</span>
             <span class="s">&#39;exist active deployments&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_teardown</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--ignore-validation&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;ignore_validation&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag indicating confirmation for teardown even if there &#39;</span>
             <span class="s">&#39;are validation conflicts&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_force_optional_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_teardown</span><span class="p">,</span>
        <span class="s">&#39;A flag indicating confirmation for the teardown request&#39;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_teardown</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_teardown</span><span class="p">,</span> <span class="n">_teardown_cosmo</span><span class="p">)</span>

    <span class="c"># blueprints subparser</span>
    <span class="n">blueprints_subparsers</span> <span class="o">=</span> <span class="n">parser_blueprints</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">()</span>

    <span class="n">parser_blueprints_upload</span> <span class="o">=</span> <span class="n">blueprints_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;upload&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for uploading a blueprint to the management server&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_blueprints_download</span> <span class="o">=</span> <span class="n">blueprints_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;download&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for downloading a blueprint from the management server&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_blueprints_list</span> <span class="o">=</span> <span class="n">blueprints_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;list&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for listing all uploaded blueprints&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_blueprints_delete</span> <span class="o">=</span> <span class="n">blueprints_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;delete&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for deleting an uploaded blueprint&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_blueprints_validate</span> <span class="o">=</span> <span class="n">blueprints_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;validate&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for validating a blueprint&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_blueprints_validate</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;blueprint_file&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;BLUEPRINT_FILE&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(),</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Path to blueprint file to be validated&#39;</span>
    <span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_blueprints_validate</span><span class="p">,</span> <span class="n">_validate_blueprint</span><span class="p">)</span>

    <span class="n">parser_blueprints_upload</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;blueprint_path&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;BLUEPRINT_FILE&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;Path to the application&#39;s blueprint file&quot;</span>
    <span class="p">)</span>
    <span class="n">_add_blueprint_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_blueprints_upload</span><span class="p">,</span>
        <span class="s">&quot;Set the id of the uploaded blueprint&quot;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_blueprints_upload</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_blueprints_upload</span><span class="p">,</span> <span class="n">_upload_blueprint</span><span class="p">)</span>

    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_blueprints_list</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_blueprints_list</span><span class="p">,</span> <span class="n">_list_blueprints</span><span class="p">)</span>

    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_blueprints_download</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_blueprints_download</span><span class="p">,</span> <span class="n">_download_blueprint</span><span class="p">)</span>

    <span class="n">_add_blueprint_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_blueprints_download</span><span class="p">,</span>
        <span class="s">&quot;The id fo the blueprint to download&quot;</span><span class="p">)</span>
    <span class="n">parser_blueprints_download</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;--output&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;output&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;OUTPUT&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&quot;The output file path of the blueprint to be downloaded&quot;</span>
    <span class="p">)</span>

    <span class="n">_add_blueprint_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_blueprints_delete</span><span class="p">,</span>
        <span class="s">&quot;The id of the blueprint meant for deletion&quot;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_blueprints_delete</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_blueprints_delete</span><span class="p">,</span> <span class="n">_delete_blueprint</span><span class="p">)</span>

    <span class="c"># deployments subparser</span>
    <span class="n">deployments_subparsers</span> <span class="o">=</span> <span class="n">parser_deployments</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">()</span>
    <span class="n">parser_deployments_create</span> <span class="o">=</span> <span class="n">deployments_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;create&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for creating a deployment of a blueprint&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_deployments_delete</span> <span class="o">=</span> <span class="n">deployments_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;delete&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for deleting a deployment&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_deployments_execute</span> <span class="o">=</span> <span class="n">deployments_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;execute&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for executing a deployment of a blueprint&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_deployments_list</span> <span class="o">=</span> <span class="n">deployments_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;list&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for listing all deployments or all deployments&#39;</span>
             <span class="s">&#39;of a blueprint&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_blueprint_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_deployments_create</span><span class="p">,</span>
        <span class="s">&quot;The id of the blueprint meant for deployment&quot;</span><span class="p">)</span>
    <span class="n">_add_deployment_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_deployments_create</span><span class="p">,</span>
        <span class="s">&quot;A unique id that will be assigned to the created deployment&quot;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_deployments_create</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_deployments_create</span><span class="p">,</span> <span class="n">_create_deployment</span><span class="p">)</span>

    <span class="n">_add_deployment_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_deployments_delete</span><span class="p">,</span>
        <span class="s">&quot;The deployment&#39;s id&quot;</span><span class="p">)</span>
    <span class="n">parser_deployments_delete</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--ignore-live-nodes&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;ignore_live_nodes&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag indicating whether or not to delete the deployment even &#39;</span>
             <span class="s">&#39;if there exist live nodes for it&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_deployments_delete</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_deployments_delete</span><span class="p">,</span> <span class="n">_delete_deployment</span><span class="p">)</span>

    <span class="n">parser_deployments_execute</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;workflow&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;WORKFLOW&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The workflow to execute&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_deployment_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_deployments_execute</span><span class="p">,</span>
        <span class="s">&#39;The id of the deployment to execute the operation on&#39;</span><span class="p">)</span>
    <span class="n">parser_deployments_execute</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--timeout&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;timeout&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;TIMEOUT&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Operation timeout in seconds (The execution itself will keep &#39;</span>
             <span class="s">&#39;going, it is the CLI that will stop waiting for it to terminate)&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_deployments_execute</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--force&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;force&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Whether the workflow should execute even if there is an ongoing&#39;</span>
             <span class="s">&#39; execution for the provided deployment&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_deployments_execute</span><span class="p">)</span>
    <span class="n">_add_include_logs_argument_to_parser</span><span class="p">(</span><span class="n">parser_deployments_execute</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_deployments_execute</span><span class="p">,</span>
                             <span class="n">_execute_deployment_workflow</span><span class="p">)</span>

    <span class="n">_add_blueprint_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_deployments_list</span><span class="p">,</span>
        <span class="s">&#39;The id of a blueprint to list deployments for&#39;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_deployments_list</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_deployments_list</span><span class="p">,</span>
                             <span class="n">_list_blueprint_deployments</span><span class="p">)</span>

    <span class="c"># workflows subparser</span>
    <span class="n">workflows_subparsers</span> <span class="o">=</span> <span class="n">parser_workflows</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">()</span>
    <span class="n">parser_workflows_list</span> <span class="o">=</span> <span class="n">workflows_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;list&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for listing workflows for a deployment&#39;</span><span class="p">)</span>
    <span class="n">_add_deployment_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_workflows_list</span><span class="p">,</span>
        <span class="s">&#39;The id of the deployment whose workflows to list&#39;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_workflows_list</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_workflows_list</span><span class="p">,</span> <span class="n">_list_workflows</span><span class="p">)</span>

    <span class="c"># Executions list sub parser</span>
    <span class="n">executions_subparsers</span> <span class="o">=</span> <span class="n">parser_executions</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">()</span>
    <span class="n">parser_executions_get</span> <span class="o">=</span> <span class="n">executions_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;get&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for getting an execution by its id&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_execution_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_executions_get</span><span class="p">,</span>
        <span class="s">&#39;The id of the execution to get&#39;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_executions_get</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_executions_get</span><span class="p">,</span>
                             <span class="n">_get_execution</span><span class="p">)</span>

    <span class="n">parser_executions_list</span> <span class="o">=</span> <span class="n">executions_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;list&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;command for listing all executions of a deployment&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_deployment_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_executions_list</span><span class="p">,</span>
        <span class="s">&#39;The id of the deployment whose executions to list&#39;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_executions_list</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_executions_list</span><span class="p">,</span>
                             <span class="n">_list_deployment_executions</span><span class="p">)</span>

    <span class="n">parser_executions_cancel</span> <span class="o">=</span> <span class="n">executions_subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
        <span class="s">&#39;cancel&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Cancel an execution by its id&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_execution_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_executions_cancel</span><span class="p">,</span>
        <span class="s">&#39;The id of the execution to cancel&#39;</span><span class="p">)</span>
    <span class="n">_add_force_optional_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_executions_cancel</span><span class="p">,</span>
        <span class="s">&#39;A flag indicating authorization to terminate the execution abruptly &#39;</span>
        <span class="s">&#39;rather than request an orderly termination&#39;</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_executions_cancel</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_executions_cancel</span><span class="p">,</span>
                             <span class="n">_cancel_execution</span><span class="p">)</span>

    <span class="n">_add_execution_id_argument_to_parser</span><span class="p">(</span>
        <span class="n">parser_events</span><span class="p">,</span>
        <span class="s">&#39;The id of the execution to get events for&#39;</span><span class="p">)</span>
    <span class="n">_add_include_logs_argument_to_parser</span><span class="p">(</span><span class="n">parser_events</span><span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_events</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_events</span><span class="p">,</span> <span class="n">_get_events</span><span class="p">)</span>

    <span class="c"># dev subparser</span>
    <span class="n">parser_dev</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;run&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;RUN&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Command for running tasks.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_dev</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--tasks&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;tasks&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;TASKS_LIST&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A comma separated list of fabric tasks to run.&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_dev</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;--tasks-file&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;tasks_file&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;TASKS_FILE&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Path to a tasks file&#39;</span>
    <span class="p">)</span>
    <span class="n">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser_dev</span><span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_dev</span><span class="p">,</span> <span class="n">_run_dev</span><span class="p">)</span>

    <span class="c"># ssh subparser</span>
    <span class="n">parser_ssh</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--command&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;ssh_command&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;COMMAND&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Execute command over SSH&#39;</span>
    <span class="p">)</span>
    <span class="n">parser_ssh</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--plain&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;ssh_plain_mode&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Leave authentication to user&#39;</span>
    <span class="p">)</span>
    <span class="n">_set_handler_for_command</span><span class="p">(</span><span class="n">parser_ssh</span><span class="p">,</span> <span class="n">_run_ssh</span><span class="p">)</span>

    <span class="n">argcomplete</span><span class="o">.</span><span class="n">autocomplete</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_provider_module</span><span class="p">(</span><span class="n">provider_name</span><span class="p">,</span> <span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module_or_pkg_desc</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_or_pkg_desc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c"># module_or_pkg_desc[1] is the pathname of found module/package,</span>
            <span class="c"># if it&#39;s empty none were found</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Provider {0} not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">provider_name</span><span class="p">))</span>
            <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">module</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="n">provider_name</span><span class="p">,</span> <span class="o">*</span><span class="n">module_or_pkg_desc</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_or_pkg_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c"># module_or_pkg_desc[0] is None and module_or_pkg_desc[1] is not</span>
            <span class="c"># empty only when we&#39;ve loaded a package rather than a module.</span>
            <span class="c"># Re-searching for the module inside the now-loaded package</span>
            <span class="c"># with the same name.</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span>
                <span class="n">provider_name</span><span class="p">,</span>
                <span class="o">*</span><span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">provider_name</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__path__</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">module</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Could not import module {0} &#39;</span>
               <span class="s">&#39;maybe {0} provider module was not installed?&#39;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">provider_name</span><span class="p">))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_include_logs_argument_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-l&#39;</span><span class="p">,</span> <span class="s">&#39;--include-logs&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;include_logs&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag whether to include logs in returned events&#39;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_force_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">help_message</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--force&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;force&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">help_message</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_management_ip_optional_argument_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--management-ip&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;management_ip&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;MANAGEMENT_IP&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;The cloudify management server ip address&#39;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_blueprint_id_argument_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">help_message</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="s">&#39;--blueprint-id&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;blueprint_id&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;BLUEPRINT_ID&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">help_message</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_deployment_id_argument_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">help_message</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-d&#39;</span><span class="p">,</span> <span class="s">&#39;--deployment-id&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;deployment_id&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;DEPLOYMENT_ID&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">help_message</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_execution_id_argument_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">help_message</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-e&#39;</span><span class="p">,</span> <span class="s">&#39;--execution-id&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;execution_id&#39;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s">&#39;EXECUTION_ID&#39;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">help_message</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_set_handler_for_command</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
    <span class="n">_add_verbosity_argument_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verbosity_aware_handler</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">output_level</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">output_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
        <span class="n">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">handler</span><span class="o">=</span><span class="n">verbosity_aware_handler</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_verbosity_argument_to_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbosity&#39;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s">&#39;verbosity&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s">&#39;A flag for setting verbose output&#39;</span>
    <span class="p">)</span>


<div class="viewcode-block" id="set_global_verbosity_level"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.set_global_verbosity_level">[docs]</a><span class="k">def</span> <span class="nf">set_global_verbosity_level</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sets the global verbosity level for console and the lgr logger.</span>

<span class="sd">    :param bool is_verbose_output: should be output be verbose</span>
<span class="sd">    :rtype: `None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># we need both lgr.setLevel and the verbose_output parameter</span>
    <span class="c"># since not all output is generated at the logger level.</span>
    <span class="c"># verbose_output can help us control that.</span>
    <span class="k">global</span> <span class="n">verbose_output</span>
    <span class="n">verbose_output</span> <span class="o">=</span> <span class="n">is_verbose_output</span>
    <span class="k">if</span> <span class="n">verbose_output</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="c"># print &#39;level is: &#39; + str(lgr.getEffectiveLevel())</span>

</div>
<span class="k">def</span> <span class="nf">_read_config</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">,</span> <span class="n">provider_dir</span><span class="p">,</span> <span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_deep_merge_dictionaries</span><span class="p">(</span><span class="n">overriding_dict</span><span class="p">,</span> <span class="n">overridden_dict</span><span class="p">):</span>
        <span class="n">merged_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">overridden_dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">overriding_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">merged_dict</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">merged_dict</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">merged_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">_deep_merge_dictionaries</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">merged_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;type conflict at key {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merged_dict</span>

    <span class="n">set_global_verbosity_level</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file_path</span><span class="p">:</span>
        <span class="n">config_file_path</span> <span class="o">=</span> <span class="n">CONFIG_FILE_NAME</span>
    <span class="n">defaults_config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">provider_dir</span><span class="p">,</span>
        <span class="n">DEFAULTS_CONFIG_FILE_NAME</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="n">defaults_config_file_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">defaults_config_file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Missing the defaults configuration file; &#39;</span>
                             <span class="s">&#39;expected to find it at {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                 <span class="n">defaults_config_file_path</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Missing the configuration file; expected to find &#39;</span>
                         <span class="s">&#39;it at {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">))</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reading provider config files&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">,</span> \
            <span class="nb">open</span><span class="p">(</span><span class="n">defaults_config_file_path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">defaults_config_file</span><span class="p">:</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;safe loading user config&#39;</span><span class="p">)</span>
        <span class="n">user_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">config_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;safe loading default config&#39;</span><span class="p">)</span>
        <span class="n">defaults_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">defaults_config_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;merging configs&#39;</span><span class="p">)</span>
    <span class="n">merged_config</span> <span class="o">=</span> <span class="n">_deep_merge_dictionaries</span><span class="p">(</span><span class="n">user_config</span><span class="p">,</span> <span class="n">defaults_config</span><span class="p">)</span> \
        <span class="k">if</span> <span class="n">user_config</span> <span class="k">else</span> <span class="n">defaults_config</span>
    <span class="k">return</span> <span class="n">merged_config</span>


<span class="k">def</span> <span class="nf">_init_cosmo</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">set_global_verbosity_level</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="n">target_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">target_dir</span><span class="p">)</span>
    <span class="n">provider</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">provider</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">target_directory</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Target directory doesn&#39;t exist.&quot;</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span>
                                   <span class="n">CLOUDIFY_WD_SETTINGS_FILE_NAME</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">reset_config</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Target directory is already initialized. &#39;</span>
                   <span class="s">&#39;Use the &quot;-r&quot; flag to force &#39;</span>
                   <span class="s">&#39;reinitialization (might overwrite &#39;</span>
                   <span class="s">&#39;provider configuration files if exist).&#39;</span><span class="p">)</span>
            <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c"># resetting provider configuration</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;resetting configuration...&#39;</span><span class="p">)</span>
            <span class="n">init</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span>
                 <span class="n">args</span><span class="o">.</span><span class="n">reset_config</span><span class="p">,</span>
                 <span class="n">creds</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">creds</span><span class="p">,</span>
                 <span class="n">is_verbose_output</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Configuration reset complete&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Initializing Cloudify&quot;</span><span class="p">)</span>
    <span class="n">provider_module_name</span> <span class="o">=</span> <span class="n">init</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">reset_config</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">install</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">creds</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="c"># creating .cloudify file</span>
    <span class="n">_dump_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">CosmoWorkingDirectorySettings</span><span class="p">(),</span>
                                     <span class="n">target_directory</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">_update_wd_settings</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span> <span class="k">as</span> <span class="n">wd_settings</span><span class="p">:</span>
        <span class="n">wd_settings</span><span class="o">.</span><span class="n">set_provider</span><span class="p">(</span><span class="n">provider_module_name</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Initialization complete&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">reset_config</span><span class="p">,</span> <span class="n">install</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
         <span class="n">creds</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        iniatializes a provider by copying its config files to the cwd.</span>
<span class="sd">        First, will look for a module named cloudify_#provider#.</span>
<span class="sd">        If not found, will look for #provider#.</span>
<span class="sd">        If install is True, will install the supplied provider and perform</span>
<span class="sd">        the search again.</span>

<span class="sd">        :param string provider: the provider&#39;s name</span>
<span class="sd">        :param string target_directory: target directory for the config files</span>
<span class="sd">        :param bool reset_config: if True, overrides the current config.</span>
<span class="sd">        :param bool install: if supplied, will also install the desired</span>
<span class="sd">         provider according to the given url or module name (pypi).</span>
<span class="sd">        :param creds: a comma separated key=value list of credential info.</span>
<span class="sd">         this is specific to each provider.</span>
<span class="sd">        :param bool is_verbose_output: if True, output will be verbose.</span>
<span class="sd">        :rtype: `string` representing the provider&#39;s module name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_global_verbosity_level</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_provider_by_name</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># searching first for the standard name for providers</span>
                <span class="c"># (i.e. cloudify_XXX)</span>
                <span class="n">provider_module_name</span> <span class="o">=</span> <span class="s">&#39;cloudify_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
                <span class="c"># print provider_module_name</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">provider_module_name</span><span class="p">,</span>
                        <span class="n">_get_provider_module</span><span class="p">(</span><span class="n">provider_module_name</span><span class="p">,</span>
                                             <span class="n">is_verbose_output</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">CosmoCliError</span><span class="p">:</span>
                <span class="c"># if provider was not found, search for the exact literal the</span>
                <span class="c"># user requested instead</span>
                <span class="n">provider_module_name</span> <span class="o">=</span> <span class="n">provider</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">provider_module_name</span><span class="p">,</span>
                        <span class="n">_get_provider_module</span><span class="p">(</span><span class="n">provider_module_name</span><span class="p">,</span>
                                             <span class="n">is_verbose_output</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">provider_module_name</span><span class="p">,</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">_get_provider_by_name</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">install</span><span class="p">:</span>
                <span class="n">local</span><span class="p">(</span><span class="s">&#39;pip install {0} --process-dependency-links&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">install</span><span class="p">))</span>
            <span class="n">provider_module_name</span><span class="p">,</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">_get_provider_by_name</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">reset_config</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">CONFIG_FILE_NAME</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Target directory already contains a &#39;</span>
                   <span class="s">&#39;provider configuration file; &#39;</span>
                   <span class="s">&#39;use the &quot;-r&quot; flag to &#39;</span>
                   <span class="s">&#39;reset it back to its default values.&#39;</span><span class="p">)</span>
            <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># try to get the path if the provider is a module</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">provider_dir</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># if not, assume it&#39;s in the package&#39;s dir</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">provider_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
            <span class="n">files_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">provider_dir</span><span class="p">,</span> <span class="n">CONFIG_FILE_NAME</span><span class="p">)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;copying provider files from {0} to {1}&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files_path</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">files_path</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">creds</span><span class="p">:</span>
            <span class="n">src_config_file</span> <span class="o">=</span> <span class="s">&#39;{}/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">provider_dir</span><span class="p">,</span>
                                             <span class="n">DEFAULTS_CONFIG_FILE_NAME</span><span class="p">)</span>
            <span class="n">dst_config_file</span> <span class="o">=</span> <span class="s">&#39;{}/{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span>
                                             <span class="n">CONFIG_FILE_NAME</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src_config_file</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">provider_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="c"># print provider_config</span>
                <span class="c"># TODO: handle cases in which creds might contain &#39;,&#39; or &#39;=&#39;</span>
                <span class="k">if</span> <span class="s">&#39;credentials&#39;</span> <span class="ow">in</span> <span class="n">provider_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">cred</span> <span class="ow">in</span> <span class="n">creds</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">cred</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">provider_config</span><span class="p">[</span><span class="s">&#39;credentials&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">provider_config</span><span class="p">[</span><span class="s">&#39;credentials&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;could not find key &quot;{0}&quot; in config file&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                            <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="s">&#39;key not found&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;credentials section not found in config&#39;</span><span class="p">)</span>
            <span class="c"># print yaml.dump(provider_config)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_config_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">provider_config</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">provider_module_name</span>

</div>
<span class="k">def</span> <span class="nf">_bootstrap_cosmo</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">provider_name</span> <span class="o">=</span> <span class="n">_get_provider</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="n">provider</span> <span class="o">=</span> <span class="n">_get_provider_module</span><span class="p">(</span><span class="n">provider_name</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">provider_dir</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">provider_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
    <span class="n">provider_config</span> <span class="o">=</span> <span class="n">_read_config</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config_file_path</span><span class="p">,</span>
                                   <span class="n">provider_dir</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">ProviderManager</span><span class="p">(</span><span class="n">provider_config</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">skip_validations</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">validate_only</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;please choose one of skip-validations or &#39;</span>
                 <span class="s">&#39;validate-only flags, not both.&#39;</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;bootstrapping using {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">provider_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">skip_validations</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;validating provider resources and configuration&#39;</span><span class="p">)</span>
        <span class="n">validation_errors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">pm</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">validation_errors</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">validate_schema</span><span class="p">(</span><span class="n">validation_errors</span><span class="p">,</span>
                                                   <span class="n">schema</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;schema validation disabled&#39;</span><span class="p">)</span>
        <span class="c"># if the validation_errors dict return empty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pm</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">validation_errors</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">validation_errors</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;provider validations completed successfully&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;provider validations failed!&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CosmoValidationError</span><span class="p">(</span><span class="s">&#39;provider validations failed!&#39;</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;provider validations failed!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">validate_only</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">with</span> <span class="n">_protected_provider_call</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;provisioning resources for management server...&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">provision</span><span class="p">()</span>

    <span class="n">provider_context</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">mgmt_ip</span><span class="p">,</span> <span class="n">private_ip</span><span class="p">,</span> <span class="n">ssh_key</span><span class="p">,</span> <span class="n">ssh_user</span><span class="p">,</span> <span class="n">provider_context</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;provisioning complete&#39;</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;bootstrapping the management server...&#39;</span><span class="p">)</span>
        <span class="n">installed</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">,</span> <span class="n">private_ip</span><span class="p">,</span> <span class="n">ssh_key</span><span class="p">,</span>
                                 <span class="n">ssh_user</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dev_mode</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;bootstrapping complete&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">installed</span> <span class="k">else</span> \
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;bootstrapping failed!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;provisioning failed!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">installed</span><span class="p">:</span>
        <span class="n">_update_provider_context</span><span class="p">(</span><span class="n">provider_config</span><span class="p">,</span> <span class="n">provider_context</span><span class="p">)</span>

        <span class="n">mgmt_ip</span> <span class="o">=</span> <span class="n">mgmt_ip</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">_update_wd_settings</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span> <span class="k">as</span> <span class="n">wd_settings</span><span class="p">:</span>
            <span class="n">wd_settings</span><span class="o">.</span><span class="n">set_management_server</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">)</span>
            <span class="n">wd_settings</span><span class="o">.</span><span class="n">set_management_key</span><span class="p">(</span><span class="n">ssh_key</span><span class="p">)</span>
            <span class="n">wd_settings</span><span class="o">.</span><span class="n">set_management_user</span><span class="p">(</span><span class="n">ssh_user</span><span class="p">)</span>
            <span class="n">wd_settings</span><span class="o">.</span><span class="n">set_provider_context</span><span class="p">(</span><span class="n">provider_context</span><span class="p">)</span>

        <span class="c"># storing provider context on management server</span>
        <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">)</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">create_context</span><span class="p">(</span><span class="n">provider_name</span><span class="p">,</span>
                                                         <span class="n">provider_context</span><span class="p">)</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s">&quot;management server is up at {0} (is now set as the default &quot;</span>
            <span class="s">&quot;management server)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">keep_up</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;topology will remain up&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;tearing down topology&#39;</span>
                     <span class="s">&#39; due to bootstrap failure&#39;</span><span class="p">)</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">teardown</span><span class="p">(</span><span class="n">provider_context</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoBootstrapError</span><span class="p">()</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_update_provider_context</span><span class="p">(</span><span class="n">provider_config</span><span class="p">,</span> <span class="n">provider_context</span><span class="p">):</span>
    <span class="n">cloudify</span> <span class="o">=</span> <span class="n">provider_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cloudify&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">cloudify</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cloudify_agent&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">min_workers</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;min_workers&#39;</span><span class="p">,</span> <span class="n">AGENT_MIN_WORKERS</span><span class="p">)</span>
    <span class="n">max_workers</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;max_workers&#39;</span><span class="p">,</span> <span class="n">AGENT_MAX_WORKERS</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
    <span class="n">remote_execution_port</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;remote_execution_port&#39;</span><span class="p">,</span>
                                      <span class="n">REMOTE_EXECUTION_PORT</span><span class="p">)</span>
    <span class="n">compute</span> <span class="o">=</span> <span class="n">provider_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;compute&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">agent_servers</span> <span class="o">=</span> <span class="n">compute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;agent_servers&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">agents_keypair</span> <span class="o">=</span> <span class="n">agent_servers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;agents_keypair&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">auto_generated</span> <span class="o">=</span> <span class="n">agents_keypair</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;auto_generated&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">private_key_target_path</span> <span class="o">=</span> <span class="n">auto_generated</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;private_key_target_path&#39;</span><span class="p">,</span>
                                                 <span class="n">AGENT_KEY_PATH</span><span class="p">)</span>

    <span class="n">workflows</span> <span class="o">=</span> <span class="n">cloudify</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;workflows&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">workflow_task_retries</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;task_retries&#39;</span><span class="p">,</span>
                                          <span class="n">WORKFLOW_TASK_RETRIES</span><span class="p">)</span>
    <span class="n">workflow_task_retry_interval</span> <span class="o">=</span> <span class="n">workflows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;retry_interval&#39;</span><span class="p">,</span>
                                                 <span class="n">WORKFLOW_TASK_RETRY_INTERVAL</span><span class="p">)</span>

    <span class="n">provider_context</span><span class="p">[</span><span class="s">&#39;cloudify&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;cloudify_agent&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;min_workers&#39;</span><span class="p">:</span> <span class="n">min_workers</span><span class="p">,</span>
            <span class="s">&#39;max_workers&#39;</span><span class="p">:</span> <span class="n">max_workers</span><span class="p">,</span>
            <span class="s">&#39;agent_key_path&#39;</span><span class="p">:</span> <span class="n">private_key_target_path</span><span class="p">,</span>
            <span class="s">&#39;remote_execution_port&#39;</span><span class="p">:</span> <span class="n">remote_execution_port</span>
        <span class="p">},</span>
        <span class="s">&#39;workflows&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;task_retries&#39;</span><span class="p">:</span> <span class="n">workflow_task_retries</span><span class="p">,</span>
            <span class="s">&#39;task_retry_interval&#39;</span><span class="p">:</span> <span class="n">workflow_task_retry_interval</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">provider_context</span><span class="p">[</span><span class="s">&#39;cloudify&#39;</span><span class="p">][</span><span class="s">&#39;cloudify_agent&#39;</span><span class="p">][</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>


<span class="k">def</span> <span class="nf">_teardown_cosmo</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">is_verbose_output</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;This action requires additional &quot;</span>
               <span class="s">&quot;confirmation. Add the &#39;-f&#39; or &#39;--force&#39; &quot;</span>
               <span class="s">&quot;flags to your command if you are certain &quot;</span>
               <span class="s">&quot;this command should be executed.&quot;</span><span class="p">)</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">mgmt_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore_deployments</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">deployments</span><span class="o">.</span><span class="n">list</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Management server {0} has active deployments. Add the &quot;</span>
               <span class="s">&quot;&#39;--ignore-deployments&#39; flag to your command to ignore &quot;</span>
               <span class="s">&quot;these deployments and execute topology teardown.&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">provider_name</span><span class="p">,</span> <span class="n">provider_context</span> <span class="o">=</span> \
        <span class="n">_get_provider_name_and_context</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="n">provider</span> <span class="o">=</span> <span class="n">_get_provider_module</span><span class="p">(</span><span class="n">provider_name</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">provider_dir</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">provider_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
    <span class="n">provider_config</span> <span class="o">=</span> <span class="n">_read_config</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config_file_path</span><span class="p">,</span>
                                   <span class="n">provider_dir</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">ProviderManager</span><span class="p">(</span><span class="n">provider_config</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;tearing down {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">_protected_provider_call</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">):</span>
        <span class="n">pm</span><span class="o">.</span><span class="n">teardown</span><span class="p">(</span><span class="n">provider_context</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore_validation</span><span class="p">)</span>

    <span class="c"># cleaning relevant data from working directory settings</span>
    <span class="k">with</span> <span class="n">_update_wd_settings</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span> <span class="k">as</span> <span class="n">wd_settings</span><span class="p">:</span>
        <span class="c"># wd_settings.set_provider_context(provider_context)</span>
        <span class="n">wd_settings</span><span class="o">.</span><span class="n">remove_management_server_context</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">)</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;teardown complete&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">is_verbose_output</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span>
    <span class="n">cosmo_wd_settings</span> <span class="o">=</span> <span class="n">_load_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&#39;management_ip&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">translate_management_alias</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_management_server</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_management_server</span><span class="p">()</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Must either first run &#39;cfy use&#39; command for a &quot;</span>
           <span class="s">&quot;management server or provide a management &quot;</span>
           <span class="s">&quot;server ip explicitly&quot;</span><span class="p">)</span>
    <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_provider</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">cosmo_wd_settings</span> <span class="o">=</span> <span class="n">_load_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_provider</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_provider</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Provider is not set in working directory settings&quot;</span>
    <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_mgmt_user</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">cosmo_wd_settings</span> <span class="o">=</span> <span class="n">_load_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_management_user</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_management_user</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Management User is not set in working directory settings&quot;</span>
    <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_mgmt_key</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">cosmo_wd_settings</span> <span class="o">=</span> <span class="n">_load_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_management_key</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_management_key</span><span class="p">()</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Management Key is not set in working directory settings&quot;</span>
    <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_provider_name_and_context</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">,</span> <span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c"># trying to retrieve provider context from server</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">mgmt_ip</span><span class="p">)</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;context&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">CloudifyClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Failed to get provider context from server: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

    <span class="c"># using the local provider context instead (if it&#39;s relevant for the</span>
    <span class="c"># target server)</span>
    <span class="n">cosmo_wd_settings</span> <span class="o">=</span> <span class="n">_load_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_provider_context</span><span class="p">():</span>
        <span class="n">default_mgmt_server_ip</span> <span class="o">=</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_management_server</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">default_mgmt_server_ip</span> <span class="o">==</span> <span class="n">mgmt_ip</span><span class="p">:</span>
            <span class="n">provider_name</span> <span class="o">=</span> <span class="n">_get_provider</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">provider_name</span><span class="p">,</span> <span class="n">cosmo_wd_settings</span><span class="o">.</span><span class="n">get_provider_context</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># the local provider context data is for a different server</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Failed to get provider context from target server&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Provider context is not set in working directory settings (&quot;</span> \
              <span class="s">&quot;The provider is used during the bootstrap and teardown &quot;</span> \
              <span class="s">&quot;process. This probably means that the manager was started &quot;</span> \
              <span class="s">&quot;manually, without the bootstrap command therefore calling &quot;</span> \
              <span class="s">&quot;teardown is not supported).&quot;</span>
    <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_status</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&#39;querying management server {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">management_ip</span><span class="p">))</span>

    <span class="n">status_result</span> <span class="o">=</span> <span class="n">_get_management_server_status</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status_result</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s">&quot;REST service at management server {0} is up and running&quot;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">management_ip</span><span class="p">))</span>

        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Services information:&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">status_result</span><span class="p">[</span><span class="s">&#39;services&#39;</span><span class="p">]:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">{0}</span><span class="se">\t</span><span class="s">{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">service</span><span class="p">[</span><span class="s">&#39;display_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
                <span class="n">service</span><span class="p">[</span><span class="s">&#39;instances&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s">&#39;instances&#39;</span> <span class="ow">in</span> <span class="n">service</span> <span class="k">else</span>
                <span class="s">&#39;Unknown&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s">&quot;REST service at management server {0} is not responding&quot;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">management_ip</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">_get_management_server_status</span><span class="p">(</span><span class="n">management_ip</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">CloudifyClientError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">_use_management_server</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CLOUDIFY_WD_SETTINGS_FILE_NAME</span><span class="p">):</span>
        <span class="c"># Allowing the user to work with an existing management server</span>
        <span class="c"># even if &quot;init&quot; wasn&#39;t called prior to this.</span>
        <span class="n">_dump_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">CosmoWorkingDirectorySettings</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_get_management_server_status</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Can&#39;t use management server {0}: No response.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">)</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">provider_context</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;context&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">CloudifyClientError</span><span class="p">:</span>
        <span class="n">provider_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">provider_context</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">with</span> <span class="n">_update_wd_settings</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span> <span class="k">as</span> <span class="n">wd_settings</span><span class="p">:</span>
        <span class="n">wd_settings</span><span class="o">.</span><span class="n">set_management_server</span><span class="p">(</span>
            <span class="n">wd_settings</span><span class="o">.</span><span class="n">translate_management_alias</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">))</span>
        <span class="n">wd_settings</span><span class="o">.</span><span class="n">set_provider_context</span><span class="p">(</span><span class="n">provider_context</span><span class="p">)</span>
        <span class="n">wd_settings</span><span class="o">.</span><span class="n">set_provider</span><span class="p">(</span><span class="n">provider_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span>
            <span class="n">wd_settings</span><span class="o">.</span><span class="n">save_management_alias</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span>
                                              <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">,</span>
                                              <span class="n">args</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                                              <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s">&#39;Using management server {0} (alias {1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">alias</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Using management server {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_list_blueprints</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Getting blueprints list... [manager={0}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">management_ip</span><span class="p">))</span>

    <span class="n">pt</span> <span class="o">=</span> <span class="n">formatting</span><span class="o">.</span><span class="n">table</span><span class="p">([</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;created_at&#39;</span><span class="p">,</span> <span class="s">&#39;updated_at&#39;</span><span class="p">],</span>
                          <span class="n">data</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">blueprints</span><span class="o">.</span><span class="n">list</span><span class="p">())</span>

    <span class="n">_output_table</span><span class="p">(</span><span class="s">&#39;Blueprints:&#39;</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_output_table</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;{0}{1}{0}{2}{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_delete_blueprint</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">blueprint_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">blueprint_id</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&#39;Deleting blueprint {0} from management server {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">blueprint_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">blueprints</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">blueprint_id</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Deleted blueprint successfully&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_delete_deployment</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">deployment_id</span>
    <span class="n">ignore_live_nodes</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore_live_nodes</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&#39;Deleting deployment {0} from management server {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">deployment_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">deployments</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">,</span> <span class="n">ignore_live_nodes</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Deleted deployment successfully&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_upload_blueprint</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">is_verbose_output</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span>
    <span class="n">blueprint_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">blueprint_id</span>
    <span class="n">blueprint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">blueprint_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">blueprint_path</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Path to blueprint doesn&#39;t exist: {0}.&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blueprint_path</span><span class="p">))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&#39;Uploading blueprint {0} to management server {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">blueprint_path</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="n">blueprint</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">blueprints</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">blueprint_path</span><span class="p">,</span> <span class="n">blueprint_id</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&quot;Uploaded blueprint, blueprint&#39;s id is: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blueprint</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_create_deployment</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">blueprint_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">blueprint_id</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">deployment_id</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Creating new deployment from blueprint {0} at &#39;</span>
             <span class="s">&#39;management server {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blueprint_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="n">deployment</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">deployments</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">blueprint_id</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&quot;Deployment created, deployment&#39;s id is: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deployment</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_create_event_message_prefix</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&#39;context&#39;</span><span class="p">]</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;deployment_id&#39;</span><span class="p">]</span>
    <span class="n">node_info</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">operation</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="s">&#39;node_id&#39;</span> <span class="ow">in</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;node_id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">node_id</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;node_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;operation&#39;</span> <span class="ow">in</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;operation&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="s">&#39;.{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s">&#39;operation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">node_info</span> <span class="o">=</span> <span class="s">&#39;[{0}{1}] &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
    <span class="n">level</span> <span class="o">=</span> <span class="s">&#39;CFY&#39;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">][</span><span class="s">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;cloudify_log&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="s">&#39;LOG&#39;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;{0}: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">message</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s">&#39;@timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="s">&#39;{0} {1} &lt;{2}&gt; {3}{4}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span>
                                         <span class="n">level</span><span class="p">,</span>
                                         <span class="n">deployment_id</span><span class="p">,</span>
                                         <span class="n">node_info</span><span class="p">,</span>
                                         <span class="n">message</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_events_logger</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">verbose_events_logger</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">default_events_logger</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_create_event_message_prefix</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">verbose_events_logger</span>
    <span class="k">return</span> <span class="n">default_events_logger</span>


<span class="k">def</span> <span class="nf">_execute_deployment_workflow</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">workflow</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">deployment_id</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">timeout</span>
    <span class="n">force</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">force</span>
    <span class="n">include_logs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">include_logs</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Executing workflow &#39;{0}&#39; on deployment &#39;{1}&#39; at&quot;</span>
             <span class="s">&quot; management server {2} [timeout={3} seconds]&quot;</span>
             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="p">))</span>

    <span class="n">events_logger</span> <span class="o">=</span> <span class="n">_get_events_logger</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">events_message</span> <span class="o">=</span> <span class="s">&quot;* Run &#39;cfy events --include-logs &quot;</span>\
                     <span class="s">&quot;--execution-id {0}&#39; for retrieving the &quot;</span>\
                     <span class="s">&quot;execution&#39;s events/logs&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">execution</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">deployments</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">,</span>
                                                   <span class="n">workflow</span><span class="p">,</span>
                                                   <span class="n">force</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CreateDeploymentInProgressError</span><span class="p">:</span>
            <span class="c"># wait for deployment creation workflow to end</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Deployment creation is in progress!&#39;</span><span class="p">)</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Waiting for deployment &#39;</span>
                     <span class="s">&#39;creation workflow execution to finish...&#39;</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">wait_for_execution</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
                               <span class="n">deployment_id</span><span class="p">,</span>
                               <span class="n">get_deployment_creation_execution</span><span class="p">(</span>
                                   <span class="n">client</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">),</span>
                               <span class="n">events_handler</span><span class="o">=</span><span class="n">events_logger</span><span class="p">,</span>
                               <span class="n">include_logs</span><span class="o">=</span><span class="n">include_logs</span><span class="p">,</span>
                               <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">remaining_timeout</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span>
            <span class="n">timeout</span> <span class="o">-=</span> <span class="n">remaining_timeout</span>
            <span class="c"># try to execute user specified workflow</span>
            <span class="n">execution</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">deployments</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">,</span>
                                                   <span class="n">workflow</span><span class="p">,</span>
                                                   <span class="n">force</span><span class="p">)</span>

        <span class="n">execution</span> <span class="o">=</span> <span class="n">wait_for_execution</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
                                       <span class="n">deployment_id</span><span class="p">,</span>
                                       <span class="n">execution</span><span class="p">,</span>
                                       <span class="n">events_handler</span><span class="o">=</span><span class="n">events_logger</span><span class="p">,</span>
                                       <span class="n">include_logs</span><span class="o">=</span><span class="n">include_logs</span><span class="p">,</span>
                                       <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">execution</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Execution of workflow &#39;{0}&#39; for deployment &quot;</span>
                     <span class="s">&quot;&#39;{1}&#39; failed. [error={2}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span>
                                                        <span class="n">deployment_id</span><span class="p">,</span>
                                                        <span class="n">execution</span><span class="o">.</span><span class="n">error</span><span class="p">))</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">events_message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">execution</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">SuppressedCosmoCliError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Finished executing workflow &#39;{0}&#39; on deployment&quot;</span>
                     <span class="s">&quot;&#39;{1}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">))</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">events_message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">execution</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">ExecutionTimeoutError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Execution of workflow &#39;{0}&#39; for deployment &#39;{1}&#39; timed out. &quot;</span>
                 <span class="s">&quot;* Run &#39;cfy executions cancel --execution-id {2}&#39; to cancel&quot;</span>
                 <span class="s">&quot; the running workflow.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span>
                                                 <span class="n">deployment_id</span><span class="p">,</span>
                                                 <span class="n">e</span><span class="o">.</span><span class="n">execution_id</span><span class="p">))</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">events_message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">execution_id</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">SuppressedCosmoCliError</span><span class="p">()</span>


<span class="c"># TODO implement blueprint deployments on server side</span>
<span class="c"># because it is currently filter by the CLI</span>
<span class="k">def</span> <span class="nf">_list_blueprint_deployments</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">blueprint_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">blueprint_id</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">blueprint_id</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Getting deployments list for blueprint: &#39;</span>
                 <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s">... [manager={1}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blueprint_id</span><span class="p">,</span>
                                                   <span class="n">management_ip</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Getting deployments list... &#39;</span>
                 <span class="s">&#39;[manager={0}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">management_ip</span><span class="p">))</span>
    <span class="n">deployments</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">deployments</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">blueprint_id</span><span class="p">:</span>
        <span class="n">deployments</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">deployment</span><span class="p">:</span>
                             <span class="n">deployment</span><span class="p">[</span><span class="s">&#39;blueprintId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">blueprint_id</span><span class="p">,</span>
                             <span class="n">deployments</span><span class="p">)</span>

    <span class="n">pt</span> <span class="o">=</span> <span class="n">formatting</span><span class="o">.</span><span class="n">table</span><span class="p">([</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;blueprint_id&#39;</span><span class="p">,</span> <span class="s">&#39;created_at&#39;</span><span class="p">,</span> <span class="s">&#39;updated_at&#39;</span><span class="p">],</span>
                          <span class="n">deployments</span><span class="p">)</span>
    <span class="n">_output_table</span><span class="p">(</span><span class="s">&#39;Deployments:&#39;</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_list_workflows</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">deployment_id</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Getting workflows list for deployment: &#39;</span>
             <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s">... [manager={1}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>

    <span class="n">workflows</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">deployments</span><span class="o">.</span><span class="n">list_workflows</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">)</span>

    <span class="n">blueprint_id</span> <span class="o">=</span> <span class="n">workflows</span><span class="p">[</span><span class="s">&#39;blueprintId&#39;</span><span class="p">]</span> <span class="k">if</span> \
        <span class="s">&#39;blueprintId&#39;</span> <span class="ow">in</span> <span class="n">workflows</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">workflows</span><span class="p">[</span><span class="s">&#39;deploymentId&#39;</span><span class="p">]</span> <span class="k">if</span> \
        <span class="s">&#39;deploymentId&#39;</span> <span class="ow">in</span> <span class="n">workflows</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="n">pt</span> <span class="o">=</span> <span class="n">formatting</span><span class="o">.</span><span class="n">table</span><span class="p">([</span><span class="s">&#39;blueprint_id&#39;</span><span class="p">,</span> <span class="s">&#39;deployment_id&#39;</span><span class="p">,</span>
                           <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;created_at&#39;</span><span class="p">],</span>
                          <span class="n">data</span><span class="o">=</span><span class="n">workflows</span><span class="o">.</span><span class="n">workflows</span><span class="p">,</span>
                          <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;blueprint_id&#39;</span><span class="p">:</span> <span class="n">blueprint_id</span><span class="p">,</span>
                                    <span class="s">&#39;deployment_id&#39;</span><span class="p">:</span> <span class="n">deployment_id</span><span class="p">})</span>

    <span class="n">_output_table</span><span class="p">(</span><span class="s">&#39;Workflows:&#39;</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_cancel_execution</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="n">execution_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">execution_id</span>
    <span class="n">force</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">force</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&#39;{0}Cancelling execution {1} on management server {2}&#39;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Force-&#39;</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">execution_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>
    <span class="n">client</span><span class="o">.</span><span class="n">executions</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">execution_id</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s">&#39;A cancel request for execution {0} has been sent to management &#39;</span>
        <span class="s">&quot;server {1}. To track the execution&#39;s status, use:</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="s">&quot;cfy executions get {0}&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">execution_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_execution</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="n">execution_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">execution_id</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Getting execution: &#39;</span>
                 <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> [manager={1}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">execution_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>
        <span class="n">execution</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">executions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">execution_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">CloudifyClientError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Execution &#39;{0}&#39; not found on management server&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">execution_id</span><span class="p">))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">_print_executions</span><span class="p">([</span><span class="n">execution</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_list_deployment_executions</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">is_verbose_output</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">deployment_id</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Getting executions list for deployment: &#39;</span>
                 <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> [manager={1}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">))</span>
        <span class="n">executions</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">executions</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">CloudifyClientError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Deployment {0} does not exist on management server&#39;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">_print_executions</span><span class="p">(</span><span class="n">executions</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_print_executions</span><span class="p">(</span><span class="n">executions</span><span class="p">):</span>
    <span class="n">pt</span> <span class="o">=</span> <span class="n">formatting</span><span class="o">.</span><span class="n">table</span><span class="p">([</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;workflow_id&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span>
                           <span class="s">&#39;created_at&#39;</span><span class="p">,</span> <span class="s">&#39;error&#39;</span><span class="p">],</span>
                          <span class="n">executions</span><span class="p">)</span>
    <span class="n">_output_table</span><span class="p">(</span><span class="s">&#39;Executions:&#39;</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_events</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">management_ip</span> <span class="o">=</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Getting events from management server {0} for &quot;</span>
             <span class="s">&quot;execution id &#39;{1}&#39; &quot;</span>
             <span class="s">&quot;[include_logs={2}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">management_ip</span><span class="p">,</span>
                                         <span class="n">args</span><span class="o">.</span><span class="n">execution_id</span><span class="p">,</span>
                                         <span class="n">args</span><span class="o">.</span><span class="n">include_logs</span><span class="p">))</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">get_all_execution_events</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
                                          <span class="n">args</span><span class="o">.</span><span class="n">execution_id</span><span class="p">,</span>
                                          <span class="n">args</span><span class="o">.</span><span class="n">include_logs</span><span class="p">)</span>
        <span class="n">events_logger</span> <span class="o">=</span> <span class="n">_get_events_logger</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">events_logger</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Total events: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)))</span>
    <span class="k">except</span> <span class="n">CloudifyClientError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Execution &#39;{0}&#39; not found on management server&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">execution_id</span><span class="p">))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_run_dev</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c"># TODO: allow passing username and key path as params.</span>
    <span class="c"># env.user = args.user if args.user else _get_mgmt_user()</span>
    <span class="c"># env.key_filename = args.key if args.key else _get_mgmt_key()</span>
    <span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">_get_mgmt_user</span><span class="p">()</span>
    <span class="n">env</span><span class="o">.</span><span class="n">key_filename</span> <span class="o">=</span> <span class="n">_get_mgmt_key</span><span class="p">()</span>
    <span class="n">env</span><span class="o">.</span><span class="n">warn_only</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">env</span><span class="o">.</span><span class="n">abort_on_prompts</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">env</span><span class="o">.</span><span class="n">connection_attempts</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">env</span><span class="o">.</span><span class="n">keepalive</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">env</span><span class="o">.</span><span class="n">linewise</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">env</span><span class="o">.</span><span class="n">pool_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">env</span><span class="o">.</span><span class="n">skip_bad_hosts</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">env</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">env</span><span class="o">.</span><span class="n">forward_agent</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">env</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">env</span><span class="o">.</span><span class="n">disable_known_hosts</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">mgmt_ip</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">management_ip</span> \
        <span class="k">else</span> <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="c"># hmm... it&#39;s also possible to just pass the tasks string to fabric</span>
    <span class="c"># and let it run... need to think about it...</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tasks_file</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tasks_file</span><span class="p">))</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">tasks_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">tasks</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CosmoDevError</span><span class="p">(</span><span class="s">&#39;could not find a tasks file to import.&#39;</span>
                                    <span class="s">&#39; either create a tasks.py file in your &#39;</span>
                                    <span class="s">&#39;cwd or use the --tasks-file flag to &#39;</span>
                                    <span class="s">&#39;point to one.&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">host_string</span><span class="o">=</span><span class="n">mgmt_ip</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">task</span><span class="p">)()</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CosmoDevError</span><span class="p">(</span><span class="s">&#39;task: &quot;{0}&quot; not found&#39;</span>
                                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CosmoDevError</span><span class="p">(</span><span class="s">&#39;failed to execute: &quot;{0}&quot; &#39;</span>
                                            <span class="s">&#39;({1}) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;task_&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">task</span><span class="p">)()</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CosmoDevError</span><span class="p">(</span><span class="s">&#39;failed to execute: &quot;{0}&quot; &#39;</span>
                                                <span class="s">&#39;({1}) &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_run_ssh</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">ssh_path</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="s">&#39;ssh&#39;</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;SSH executable path: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ssh_path</span> <span class="ow">or</span> <span class="s">&#39;Not found&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ssh_path</span> <span class="ow">and</span> <span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;Windows&#39;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">SSH_WIN_NOT_FOUND</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">ssh_path</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">SSH_LINUX_NOT_FOUND</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_ssh</span><span class="p">(</span><span class="n">ssh_path</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_ssh</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;{0}@{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_get_mgmt_user</span><span class="p">(),</span>
                                    <span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">ssh_plain_mode</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;-i&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">_get_mgmt_key</span><span class="p">())])</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ssh_command</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ssh_command</span><span class="p">])</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;executing command: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)))</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Trying to connect...&#39;</span><span class="p">)</span>
    <span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_set_cli_except_hook</span><span class="p">():</span>
    <span class="n">old_excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>

    <span class="k">def</span> <span class="nf">new_excepthook</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">the_traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CosmoCliError</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">output_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Stack trace:&quot;</span><span class="p">)</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_tb</span><span class="p">(</span><span class="n">the_traceback</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">CloudifyClientError</span><span class="p">:</span>
            <span class="n">lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed making a call to REST service: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">output_level</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Stack trace:&quot;</span><span class="p">)</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_tb</span><span class="p">(</span><span class="n">the_traceback</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">SuppressedCosmoCliError</span><span class="p">:</span>
            <span class="c"># output is already generated elsewhere</span>
            <span class="c"># we only want and exit code that is not 0</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_excepthook</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">the_traceback</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">new_excepthook</span>


<span class="k">def</span> <span class="nf">_load_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CLOUDIFY_WD_SETTINGS_FILE_NAME</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;You must first initialize by running the &#39;</span>
               <span class="s">&#39;command &quot;cfy init&quot;, or choose to work with &#39;</span>
               <span class="s">&#39;an existing management server by running the &#39;</span>
               <span class="s">&#39;command &quot;cfy use&quot;.&#39;</span><span class="p">)</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_dump_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">cosmo_wd_settings</span><span class="p">,</span> <span class="n">target_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">target_file_path</span> <span class="o">=</span> <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CLOUDIFY_WD_SETTINGS_FILE_NAME</span><span class="p">)</span> <span class="k">if</span> \
        <span class="ow">not</span> <span class="n">target_dir</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span>
                                         <span class="n">CLOUDIFY_WD_SETTINGS_FILE_NAME</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_file_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cosmo_wd_settings</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_download_blueprint</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">DOWNLOADING_BLUEPRINT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">blueprint_id</span><span class="p">))</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">_get_rest_client</span><span class="p">(</span><span class="n">_get_management_server_ip</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="n">target_file</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">blueprints</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">blueprint_id</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">DOWNLOADING_BLUEPRINT_SUCCEEDED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">blueprint_id</span><span class="p">,</span>
        <span class="n">target_file</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_validate_blueprint</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">is_verbose_output</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbosity</span>
    <span class="n">target_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">blueprint_file</span>

    <span class="n">resources</span> <span class="o">=</span> <span class="n">_get_resource_base</span><span class="p">()</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">resources</span> <span class="o">+</span> <span class="s">&quot;cloudify/alias-mappings.yaml&quot;</span>

    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">VALIDATING_BLUEPRINT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parse_from_path</span><span class="p">(</span><span class="n">target_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">resources</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DSLParsingException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">VALIDATING_BLUEPRINT_FAILED</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">VALIDATING_BLUEPRINT_SUCCEEDED</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_resource_base</span><span class="p">():</span>
    <span class="n">script_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">resource_directory</span> <span class="o">=</span> <span class="n">script_directory</span> \
        <span class="o">+</span> <span class="s">&quot;/../../cloudify-manager/resources/rest-service/&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">resource_directory</span><span class="p">):</span>
        <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Found resource directory&quot;</span><span class="p">)</span>

        <span class="n">resource_directory_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="s">&#39;file:&#39;</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">pathname2url</span><span class="p">(</span>
            <span class="n">resource_directory</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">resource_directory_url</span>
    <span class="n">lgr</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Using resources from github. Branch is develop&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;https://raw.githubusercontent.com/cloudify-cosmo/&quot;</span> \
           <span class="s">&quot;cloudify-manager/develop/resources/rest-service/&quot;</span>


<span class="k">def</span> <span class="nf">_get_rest_client</span><span class="p">(</span><span class="n">management_ip</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">CloudifyClient</span><span class="p">(</span><span class="n">management_ip</span><span class="p">)</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_update_wd_settings</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">cosmo_wd_settings</span> <span class="o">=</span> <span class="n">_load_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">cosmo_wd_settings</span>
    <span class="n">_dump_cosmo_working_dir_settings</span><span class="p">(</span><span class="n">cosmo_wd_settings</span><span class="p">)</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_protected_provider_call</span><span class="p">(</span><span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Exception occurred in provider: {0}&#39;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
        <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">trace</span> <span class="k">if</span> <span class="n">is_verbose_output</span> \
            <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<div class="viewcode-block" id="CosmoWorkingDirectorySettings"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings">[docs]</a><span class="k">class</span> <span class="nc">CosmoWorkingDirectorySettings</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">YAMLObject</span><span class="p">):</span>
    <span class="n">yaml_tag</span> <span class="o">=</span> <span class="s">u&#39;!WD_Settings&#39;</span>
    <span class="n">yaml_loader</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_management_ip</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_management_key</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_management_user</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider_context</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mgmt_aliases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mgmt_to_contextual_aliases</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="CosmoWorkingDirectorySettings.get_management_server"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.get_management_server">[docs]</a>    <span class="k">def</span> <span class="nf">get_management_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_management_ip</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.set_management_server"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.set_management_server">[docs]</a>    <span class="k">def</span> <span class="nf">set_management_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_management_ip</span> <span class="o">=</span> <span class="n">management_ip</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.get_management_key"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.get_management_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_management_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_management_key</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.set_management_key"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.set_management_key">[docs]</a>    <span class="k">def</span> <span class="nf">set_management_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">management_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_management_key</span> <span class="o">=</span> <span class="n">management_key</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.get_management_user"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.get_management_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_management_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_management_user</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.set_management_user"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.set_management_user">[docs]</a>    <span class="k">def</span> <span class="nf">set_management_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_management_user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_management_user</span> <span class="o">=</span> <span class="n">_management_user</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.get_provider_context"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.get_provider_context">[docs]</a>    <span class="k">def</span> <span class="nf">get_provider_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provider_context</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.set_provider_context"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.set_provider_context">[docs]</a>    <span class="k">def</span> <span class="nf">set_provider_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider_context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider_context</span> <span class="o">=</span> <span class="n">provider_context</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.remove_management_server_context"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.remove_management_server_context">[docs]</a>    <span class="k">def</span> <span class="nf">remove_management_server_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">management_ip</span><span class="p">):</span>
        <span class="c"># Clears management server context data.</span>
        <span class="k">if</span> <span class="n">management_ip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mgmt_to_contextual_aliases</span><span class="p">:</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mgmt_to_contextual_aliases</span><span class="p">[</span><span class="n">management_ip</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.get_provider"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.get_provider">[docs]</a>    <span class="k">def</span> <span class="nf">get_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.set_provider"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.set_provider">[docs]</a>    <span class="k">def</span> <span class="nf">set_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span> <span class="o">=</span> <span class="n">provider</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.translate_management_alias"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.translate_management_alias">[docs]</a>    <span class="k">def</span> <span class="nf">translate_management_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">management_address_or_alias</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mgmt_aliases</span><span class="p">[</span><span class="n">management_address_or_alias</span><span class="p">]</span> <span class="k">if</span> \
            <span class="n">management_address_or_alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mgmt_aliases</span> \
            <span class="k">else</span> <span class="n">management_address_or_alias</span>
</div>
<div class="viewcode-block" id="CosmoWorkingDirectorySettings.save_management_alias"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoWorkingDirectorySettings.save_management_alias">[docs]</a>    <span class="k">def</span> <span class="nf">save_management_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">management_alias</span><span class="p">,</span> <span class="n">management_address</span><span class="p">,</span>
                              <span class="n">is_allow_overwrite</span><span class="p">,</span> <span class="n">is_verbose_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_allow_overwrite</span> <span class="ow">and</span> <span class="n">management_alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mgmt_aliases</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;management-server alias {0} is already in &quot;</span>
                   <span class="s">&quot;use; use -f flag to allow overwrite.&quot;</span>
                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">management_alias</span><span class="p">))</span>
            <span class="n">flgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CosmoCliError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_verbose_output</span> <span class="k">else</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mgmt_aliases</span><span class="p">[</span><span class="n">management_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">management_address</span>

</div></div>
<div class="viewcode-block" id="CosmoDevError"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoDevError">[docs]</a><span class="k">class</span> <span class="nc">CosmoDevError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="CosmoBootstrapError"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoBootstrapError">[docs]</a><span class="k">class</span> <span class="nc">CosmoBootstrapError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="CosmoValidationError"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoValidationError">[docs]</a><span class="k">class</span> <span class="nc">CosmoValidationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="CosmoCliError"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.CosmoCliError">[docs]</a><span class="k">class</span> <span class="nc">CosmoCliError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="SuppressedCosmoCliError"><a class="viewcode-back" href="../../index.html#cosmo_cli.cosmo_cli.SuppressedCosmoCliError">[docs]</a><span class="k">class</span> <span class="nc">SuppressedCosmoCliError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">_set_cli_except_hook</span><span class="p">()</span>  <span class="c"># only enable hook when this is called directly.</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Gigaspaces.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>